<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="elements/gantt-step.html">
<link rel="import" href="elements/svg-arrow.html">

<dom-module id="gantt-widget">

	<template strip-whitespace>
		<style>

			:host {
				--gantt-width: 100%;
				--gantt-height: auto;

				display: block;
				height: var(--gantt-height);
				width: var(--gantt-width);
				background: #fff;
				overflow: hidden;

				--grid-line-color: #eee;

				--no-user-select: {
					-webkit-user-select: none;
					-khtml-user-select: none;
					-moz-user-select: none;
					-ms-user-select: none;
					user-select: none;
  			}

				--gantt-bg-grid: {
					background: var(--grid-line-color);
					/* Webkit (Safari/Chrome 10) */
					background: -webkit-gradient(linear, left top, right top, color-stop(1px, var(--grid-line-color)), color-stop(0, transparent)), -webkit-gradient(linear, left top, left bottom, color-stop(1px, var(--grid-line-color)), color-stop(0, transparent));
					/* Webkit (Chrome 11+) */
					background: -webkit-linear-gradient(var(--grid-line-color) 1px, transparent 0px), -webkit-linear-gradient(0deg, var(--grid-line-color) 1px, transparent 0px);
					/* Mozilla Firefox */
					background: -moz-linear-gradient(var(--grid-line-color) 1px, transparent 0px), -moz-linear-gradient(0deg, var(--grid-line-color) 1px, transparent 0px);
					/* IE10 Consumer Preview */
					background: -ms-linear-gradient(0deg, var(--grid-line-color) 1.1px, transparent 0px), -ms-linear-gradient(90deg, var(--grid-line-color) 1.1px, transparent 0px);
					/* Opera */
					background: -o-linear-gradient(var(--grid-line-color) 1px, transparent 0px), -o-linear-gradient(90deg, var(--grid-line-color) 1px, transparent 0px);
					/* W3C Markup, IE10 Release Preview */
					background: linear-gradient(0deg, var(--grid-line-color) 1px, transparent 0px), linear-gradient(90deg, var(--grid-line-color) 1.1px, transparent 0px);

					background-attachment: local;
				}
			}

			.timeline {
				overflow: hidden;
				position: relative;
			}

			.year,
			.month,
			.day {
				padding-left: 2px;
				text-overflow: ellipsis;
				white-space: nowrap;
		   	border-right: 1px solid #A9A9A9;
		    background-color: #d0d0d0;
		    box-sizing: border-box;
		    -moz-box-sizing: border-box;
		    -webkit-box-sizing: border-box;

			    &.spacer {
			    	padding-left: 0px;
			    }
			}
			.year.spacer,
			.month.spacer,
			.day.spacer {
				padding-left: 0px;
			}

			.month:nth-of-type(even),
			.day:nth-of-type(even) {
			    background-color: #ddd;
			}
			.col.even {
			    background-color: #ccc;
			}

			.col {
				position: var(--gantt-col-position);
				left: var(--gantt-col-left);
				height: 100%;
				float: left;
				overflow: hidden;
				border-right: 1px solid #A9A9A9;
				background-color: #ddd;
				font-size: 10px;
				text-align: center;
				box-sizing: border-box;
				-moz-box-sizing: border-box;
				-webkit-box-sizing: border-box;
				-webkit-touch-callout: none;
				@apply --no-user-select;
			}

			.c-col {
				width: var(--gantt-col-center-width);
			}

			.f-col {
				width: var(--gantt-col-first-width);
			}

			.l-col {
				width: var(--gantt-col-last-width);
			}

			.col.w {
				text-align: left;
			}

			.col.weekend {
				background-color: #ccc;
			}

			.col.measure {
			    // Change min-width to adjust grid's cell width with day and hour-resolution.
				//min-width: 40px;
			}
			.col.w.measure {
				// Change min-width to adjust grid's cell width with week-resolution.
				//min-width: 70px;
			}

			.row {
				width: 100%;
				float: left;
				overflow: hidden;
				height: 15px;
				-ms-flex-pack: justify;
				-webkit-touch-callout: none;
				@apply --no-user-select;
			}
			.gantt-container {
				overflow: auto;
				@apply --no-user-select;
				@apply --gantt-bg-grid;
			}

			.gantt-content {
				background: transparent;
				overflow: hidden;
				position: relative;
			}

			.mv-el {
				position: absolute;
				top: 0;
				box-sizing: border-box;
				-moz-box-sizing: border-box;
				-webkit-box-sizing: border-box;
				height: 100%;
				z-index: 2;
				background: transparent;
				border-left: 1px dashed #ddd;
				border-right: 1px dashed #ddd;
			}

			/* Optional background svg element. */
			svg.bg-grid {
				position: absolute;
				overflow: hidden;
				top: 0;
				z-index: 0;
				background: transparent;
			}

		</style>

				<!-- >div class="timeline"></div-->
			<div id="ganttContainer" class="gantt-container" on-scroll="handleContainerScroll">
				<div id="ganttContent" class="gantt-content">
					<div class="mv-el" style="display: none;"></div>

					<template is="dom-repeat" items="{{steps}}" as="step">
			      <gantt-step step="{{step}}"
							caption="{{step.caption}}"
							description="{{step.description}}"
							show-progress="{{step.showProgress}}"
							style-name="{{step.styleName}}"
							background-color="{{step.backgroundColor}}"
							progress="{{step.progress}}"
							resizable="{{step.resizable}}"
							movable="{{step.movable}}"
							start-date="{{step.startDate}}"
							end-date="{{step.endDate}}">
						</gantt-step>
			    </template>

				</div>
			</div>
			<div style="display: none;"></div>

	</template>

	<script>
		class GanttWidget extends Polymer.Element {
			static get is() { return 'gantt-widget'; }

			static get properties() {
				return {
						ganttElement: Object,
						height: {
							type: String,
							observer: '_onHeightChanged',
						},
						width: {
							type: String,
							observer: '_onWidthChanged',
						},
						colLeft: {
							type: Number,
							value: 0,
							reflectToAttribute: true,
							notify: true,
							observer: '_onColLeftChanged',
						},
						colPosition: {
							type: String,
							value: "static",
							reflectToAttribute: true,
							notify: true,
							observer: '_onColPositionChanged',
						},
						colCenterWidth: {
							type: String,
							value: "auto",
							observer: '_onColCenterWidthChanged',
						},
						colFirstWidth: {
							type: String,
							value: "auto",
							reflectToAttribute: true,
							notify: true,
							observer: '_onColFirstWidthChanged',
						},
						colLastWidth: {
							type: String,
							value: "auto",
							reflectToAttribute: true,
							notify: true,
							observer: '_onColLastWidthChanged',
						},
						steps: {
							type: Array,
						},
				};
			}

			_onWidthChanged(width) { this.updateStyles({'--gantt-width': width }); }
			_onHeightChanged(height) { this.updateStyles({'--gantt-height': height }); }
			_onColPositionChanged(colPosition) { this.updateStyles({'--gantt-col-position': colPosition }); }
			_onColLeftChanged(colLeft) { this.updateStyles({ '--gantt-col-left': colLeft + "px" }); }
			_onColCenterWidthChanged(colCenterWidth) { this.updateStyles({'--gantt-col-center-width': colCenterWidth }); }
			_onColFirstWidthChanged(colFirstWidth) { this.updateStyles({'--gantt-col-first-width': colFirstWidth }); }
			_onColLastWidthChanged(colLastWidth) { this.updateStyles({'--gantt-col-last-width': colLastWidth }); }

			constructor() {
				super();
				window.addEventListener('gantt-lib-ready', e => this._onGanttLibReady(e, this));
			}

			ready() {
				super.ready();
			}

			connectedCallback() {
				super.connectedCallback();
				if(!this.readyAndConnected) {
					this.addEventListener('register-step', e => this._onRegisterStep(e));
				}
				this.readyAndConnected = true;

				//this.dispatchEvent(new CustomEvent('gantt-ready', {bubbles: true, composed: true, detail: {ganttElement: this}}));
			}

			_onGanttLibReady(e, gantt) {
				function nextTimeout(delayms) {
           setTimeout(function() {
                if (gantt.readyAndConnected) {
                  window.dispatchEvent(new Event('gantt-ready'));
                } else {
                    nextTimeout(10);
                }
              }, delayms);
        }
        nextTimeout(0);
			}

			_onRegisterStep(event) {
				event.detail.stepElement.ganttElement = this.ganttElement;
				if(this.ganttElement && event.detail.step && !event.detail.step.substep) {
					console.log('Registering Step ' + event.detail.step.uid);
					this.ganttElement.registerStepElement(event.detail.stepElement, event.detail.step);
				}
			}

			registerContainerScrollHandler(f) {
				this.containerScrollHandler = f;
			}
			handleContainerScroll(e) {
				if(this.containerScrollHandler) {
					this.containerScrollHandler(e);
				}
			}

			handleStepClicked(stepUid, details) {
			}
			handleOnMove(newStepUid, startDate, endDate, details) {
			}
			handleOnResize(stepUid, startDate, endDate, details) {
			}
			handleOnPredecessorChange(newPredecessorStepUid, forTargetStepUid, clearPredecessorForStepUid) {
			}
		}
		customElements.define(GanttWidget.is, GanttWidget);
	</script>

</dom-module>
